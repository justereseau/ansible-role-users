---
- name: Create group list
  set_fact:
    groups_to_add: "{{ item.groups | default([]) }}"

- name: Append sudoer group to group list
  set_fact:
    groups_to_add: "{{ groups_to_add + [ sudoer_group ] }}"
  when: item.sudoer | default(false)

- name: Create user with primary group and reset groups
  user:
    name: "{{ item.username }}"
    comment: "{{ item.name | default('') }}"
    group: "{{ item.group | default( item.username ) }}"
    groups: "{{ groups_to_add }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present

- name: Add password to user.
  user:
    name: "{{ item.username }}"
    password: "{{ item.password }}"
  when: item.password is defined

- name: Add keys to user.
  authorized_key:
    user: "{{ item.username }}"
    key: "{{ item.public_keys }}"
  when: item.public_keys is defined

- name: Allow privilege escalation without password.
  lineinfile:
    dest: /etc/sudoers.d/30-{{ item.username }}
    owner: root
    group: root
    mode: 0440
    line: "{{ item.username }} ALL=(ALL) NOPASSWD:ALL"
    state: present
    create: true
    validate: 'visudo -cf %s'
  when: item.sudoer | default(false)
